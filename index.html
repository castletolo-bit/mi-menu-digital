<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>La Gusguería - Menú Digital</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: 'Montserrat', sans-serif; }
    .tooltip {
      position: absolute;
      background: rgba(0,0,0,0.85);
      color: #fff;
      padding: 8px;
      border-radius: 6px;
      font-size: 0.8rem;
      max-width: 200px;
      z-index: 50;
    }
    .pop {
      animation: pop 0.3s ease;
    }
    @keyframes pop {
      0% { transform: scale(1); }
      50% { transform: scale(1.3); }
      100% { transform: scale(1); }
    }
  </style>
</head>
<body class="bg-gray-100">

  <!-- Header -->
  <header class="sticky top-0 bg-gradient-to-r from-orange-500 to-red-600 text-white text-center py-4 italic font-black uppercase">
    La Gusguería
  </header>

  <!-- Contenedor de productos -->
  <main id="menu" class="p-4 space-y-4">
    <p id="loading" class="text-center text-gray-600">Cargando menú...</p>
  </main>

  <!-- Footer con carrito -->
  <footer class="fixed bottom-0 left-0 right-0 bg-white shadow-lg p-4 flex justify-between items-center">
    <span>Total: $<span id="total">0</span></span>
    <button id="whatsappBtn" class="bg-green-500 text-white px-4 py-2 rounded-full shadow-md">
      Pedir por WhatsApp
    </button>
  </footer>

  <script>
    const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vT1TiLuDQq5Dk3vJjhmd534zHWNeHu4v-UAnDcfZxMpFaTNAzn-hy5Wmn8O1IqYvNUiMF7qbGfGLSBR/pub?output=csv";
    const WHATSAPP_BASE64 = "NTIxNTYzOTQ3NTQ3OA==";
    const whatsappNumber = atob(WHATSAPP_BASE64);

    let carrito = [];
    let total = 0;

    async function cargarMenu() {
      try {
        const res = await fetch(SHEET_URL);
        if (!res.ok) throw new Error("Error al cargar CSV");
        const text = await res.text();
        const rows = text.trim().split("\n").slice(1); // ignorar cabecera
        document.getElementById("loading").style.display = "none";

        rows.forEach(row => {
          const cols = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
          const [id, categoria, nombre, descES, precio, estado, imgURL, etiqueta, tooltip, descEN] = cols;

          const card = document.createElement("div");
          card.className = "flex bg-white rounded-lg shadow-md overflow-hidden";

          const img = document.createElement("img");
          img.src = imgURL;
          img.alt = nombre;
          img.className = "w-24 h-24 object-cover rounded-l-2xl cursor-pointer";
          if (estado.trim().toLowerCase() === "agotado") {
            img.classList.add("opacity-40", "grayscale");
          }

          // Tooltip
          img.addEventListener("mouseenter", e => mostrarTooltip(e, tooltip));
          img.addEventListener("mouseleave", ocultarTooltip);
          img.addEventListener("touchstart", e => mostrarTooltip(e, tooltip));
          img.addEventListener("touchend", ocultarTooltip);

          const info = document.createElement("div");
          info.className = "p-3 flex-1";
          info.innerHTML = `
            <h3 class="font-bold">${nombre}</h3>
            <p class="text-sm text-gray-600">${descES}</p>
            <p class="text-red-600 font-semibold">$${precio}</p>
          `;

          const btn = document.createElement("button");
          btn.textContent = "Agregar";
          btn.className = "bg-orange-500 text-white px-3 py-1 rounded-md mt-2";
          btn.disabled = estado.trim().toLowerCase() === "agotado";
          btn.onclick = () => agregarCarrito(nombre, precio);

          info.appendChild(btn);
          card.appendChild(img);
          card.appendChild(info);
          document.getElementById("menu").appendChild(card);
        });
      } catch (err) {
        document.getElementById("loading").textContent = "Error al cargar menú.";
        const retryBtn = document.createElement("button");
        retryBtn.textContent = "Reintentar";
        retryBtn.className = "bg-red-500 text-white px-4 py-2 rounded mt-2";
        retryBtn.onclick = cargarMenu;
        document.getElementById("menu").appendChild(retryBtn);
      }
    }

    function agregarCarrito(nombre, precio) {
      carrito.push({ nombre, precio: parseFloat(precio) });
      total += parseFloat(precio);
      const totalEl = document.getElementById("total");
      totalEl.textContent = total.toFixed(2);
      totalEl.classList.add("pop");
      setTimeout(() => totalEl.classList.remove("pop"), 300);
    }

    function mostrarTooltip(e, texto) {
      if (!texto) return;
      const tooltip = document.createElement("div");
      tooltip.className = "tooltip";
      tooltip.textContent = texto;
      document.body.appendChild(tooltip);

      const rect = e.target.getBoundingClientRect();
      let top = rect.top + window.scrollY;
      let left = rect.right + 10;

      if (left + tooltip.offsetWidth > window.innerWidth) {
        left = rect.left - tooltip.offsetWidth - 10;
      }
      if (top + tooltip.offsetHeight > window.innerHeight) {
        top = rect.top - tooltip.offsetHeight - 10;
      }

      tooltip.style.top = top + "px";
      tooltip.style.left = left + "px";
      e.target._tooltip = tooltip;
    }

    function ocultarTooltip(e) {
      if (e.target._tooltip) {
        e.target._tooltip.remove();
        e.target._tooltip = null;
      }
    }

    document.getElementById("whatsappBtn").addEventListener("click", () => {
      if (carrito.length === 0) return alert("Tu carrito está vacío, compa.");
      const folio = Math.floor(Math.random() * 100000);
      let mensaje = `*Pedido La Gusguería*\\nFolio: ${folio}\\n\\n`;
      carrito.forEach(item => {
        mensaje += `- ${item.nombre}: $${item.precio}\\n`;
      });
      mensaje += `\\n*Total: $${total.toFixed(2)}*`;

      const url = `https://wa.me/${whatsappNumber}?text=${encodeURIComponent(mensaje)}`;
      window.open(url, "_blank");
    });

    cargarMenu();
  </script>
</body>
</html>
