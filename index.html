<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>La Gusguer√≠a</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .product-card { transition: transform 0.2s; }
    .product-card:active { transform: scale(0.98); }
    .btn-add { transition: all 0.2s; }
  </style>
</head>
<body class="bg-gray-50 pb-32">

  <!-- Encabezado -->
  <header class="bg-gradient-to-br from-orange-600 to-red-600 text-white p-6 text-center shadow-lg rounded-b-3xl">
    <h1 class="text-3xl font-extrabold tracking-tight">La Gusguer√≠a</h1>
    <p class="text-sm opacity-90 mt-1">¬°Pide r√°pido antes de que se acaben!</p>
  </header>

  <!-- Contenedor del men√∫ -->
  <main id="menu-container" class="p-4 max-w-md mx-auto space-y-4 mt-2">
    <div class="text-center py-10">
      <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-orange-500 mx-auto"></div>
      <p class="text-gray-400 mt-4 text-sm">Cargando el men√∫...</p>
    </div>
  </main>

  <!-- Footer carrito -->
  <div class="fixed bottom-0 left-0 right-0 bg-white p-4 shadow-[0_-5px_20px_rgba(0,0,0,0.1)] border-t border-gray-100 flex justify-between items-center z-50">
    <div class="flex flex-col">
      <span class="text-gray-400 text-[10px] uppercase font-bold tracking-widest">Total Estimado</span>
      <span id="total-display" class="text-2xl font-black text-gray-800">$0.00</span>
    </div>
    <button onclick="enviarWhatsApp()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-xl font-bold shadow-lg shadow-green-200 flex items-center gap-2 transform active:scale-95 transition-all">
      Pedir por WhatsApp
    </button>
  </div>

  <script>
    // ==========================================
    // CONFIGURACI√ìN
    // ==========================================
    const SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vT1TiLuDQq5Dk3vJjhmd534zHWNeHu4v-UAnDcfZxMpFaTNAzn-hy5Wmn8O1IqYvNUiMF7qbGfGLSBR/pub?gid=1374506693&single=true&output=csv'; 
    const TELEFONO_BASE64 = "NTIxNTYzOTQ3NTQ3OA=="; // 521XXXXXX5478 Tel√©fono H√©ctor

    let carrito = [];
    let total = 0;

    // Decodificar Base64
    function decodeBase64(str) {
      try { return atob(str); } catch (e) { return ""; }
    }

    // ==========================================
    // CARGAR MEN√ö
    // ==========================================
    async function cargarMenu() {
      try {
        const response = await fetch(SHEET_CSV_URL + '&cache=' + new Date().getTime());
        const data = await response.text();
        const filas = data.split('\n').slice(1);

        const container = document.getElementById('menu-container');
        container.innerHTML = "";

        filas.forEach(fila => {
          const columnas = fila.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(c => c.replace(/"/g, '').trim());
          if (columnas.length < 10) return;

          const [id, categoria, nombre, descES, precioRaw, estadoRaw, imagenURL, etiqueta, tooltip, descEN] = columnas;
          const isAgotado = estadoRaw.toLowerCase() === 'agotado';
          const precio = parseFloat(precioRaw) || 0;

          let estadoBadge = '';
          let botonHtml = '';

          if (isAgotado) {
            estadoBadge = `<span class="text-red-600 font-black text-sm bg-red-50 px-2 py-1 rounded">AGOTADO</span>`;
            botonHtml = `<button disabled class="bg-gray-200 text-gray-400 w-12 h-12 rounded-xl cursor-not-allowed">x</button>`;
          } else {
            estadoBadge = etiqueta ? `<span class="text-xs bg-orange-100 text-orange-600 px-2 py-1 rounded">${etiqueta}</span>` : '';
            botonHtml = `<button onclick="agregar('${nombre}', ${precio})" class="btn-add bg-orange-100 text-orange-600 w-12 h-12 rounded-xl font-bold text-2xl hover:bg-orange-500 hover:text-white">+</button>`;
          }

          const card = `
            <div class="product-card p-4 rounded-2xl shadow-sm border border-gray-100 flex gap-4 mb-3 bg-white ${isAgotado ? 'opacity-60 grayscale' : ''}">
              <img src="${imagenURL}" alt="${nombre}" class="w-20 h-20 object-cover rounded-xl shadow-sm" />
              <div class="flex-1">
                <span class="text-[10px] uppercase font-bold text-orange-400 tracking-wider">${categoria}</span>
                <h3 class="font-bold text-gray-800 text-lg mb-1">${nombre}</h3>
                <p class="text-gray-500 text-xs">${descES}</p>
                ${estadoBadge}
                <p class="text-gray-900 font-black mt-2 text-lg">$${precio}</p>
              </div>
              <div class="flex flex-col items-center gap-2">
                ${botonHtml}
                ${tooltip ? `<span class="text-gray-400 text-xs cursor-help" title="${tooltip}">‚ÑπÔ∏è</span>` : ''}
              </div>
            </div>
          `;
          container.innerHTML += card;
        });
      } catch (e) {
        document.getElementById('menu-container').innerHTML =
          "<div class='p-4 bg-red-100 text-red-700 rounded-xl text-center'>Error de conexi√≥n. Revisa el link de Google Sheets.</div>";
      }
    }

    // ==========================================
    // CARRITO
    // ==========================================
    function agregar(nombre, precio) {
      carrito.push({ nombre, precio });
      total += precio;
      actualizarTotal();
      if (navigator.vibrate) navigator.vibrate(50);
    }

    function actualizarTotal() {
      document.getElementById('total-display').innerText = `$${total.toFixed(2)}`;
    }

    function enviarWhatsApp() {
      if (carrito.length === 0) {
        alert("üõí Tu carrito est√° vac√≠o. Agrega algo rico primero.");
        return;
      }

      const ahora = new Date();
      const folio = ahora.getHours() + "" + ahora.getMinutes() + "" + ahora.getSeconds();

      let texto = `*üìù PEDIDO #${folio}*\n`;
      texto += `_Fecha: ${ahora.toLocaleDateString()}_\n`;
      texto += `--------------------------------\n`;

      carrito.forEach(item => {
        texto += `‚ñ™Ô∏è ${item.nombre} .. $${item.precio}\n`;
      });

      texto += `--------------------------------\n`;
      texto += `*üí∞ TOTAL: $${total.toFixed(2)}*\n\n`;
      texto += `üìç _Confirmo mi pedido, espero instrucciones._`;

      const mensajeFinal = encodeURIComponent(texto);
      const telefono = decodeBase64(TELEFONO_BASE64);
      const url = `https://wa.me/${telefono}?text=${mensajeFinal}`;

      window.open(url, "_top");
    }

    // Iniciar
    cargarMenu();
  </script>
</body>
</html>
